name: Nightly Build

on:
  schedule:
    - cron: '0 20 * * *'
  workflow_dispatch:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  build:
    name: Build moran@${{ matrix.moran }} kagiroi@${{ matrix.kagiroi }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        moran: [simp, trad]
        kagiroi: [main, build]
    steps:
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git zip curl

      - name: Clone Plum
        run: git clone --depth 1 https://github.com/rime/plum.git

      - name: Run Rime Install
        env:
          branch_moran: ${{ matrix.moran }}
          branch_kagiroi: ${{ matrix.kagiroi }}
          rime_dir: ${{ github.workspace }}/dist
        run: |
          echo "Starting build for moran@$branch_moran | kagiroi@$branch_kagiroi | mungyeong@main"
          mkdir -p dist
          bash plum/rime-install rimeinn/rime-mkm/mkm-packages.conf

      - name: Cleanup & Package
        run: |
          PKG_NAME="mkm-moran@${{ matrix.moran }}-kagiroi@${{ matrix.kagiroi }}-mungyeong@main.zip"
          DEFAULT_YAML="plum/package/rimeinn/moran/default.yaml"
          echo "Packaging $PKG_NAME ..."
          sed -i '/- schema: tiger/a \  - schema: kagiroi\n  - schema: mungyeong' "$DEFAULT_YAML"
          mv "$DEFAULT_YAML" dist/
          cd dist
          zip -r -q ../"$PKG_NAME" ./*

      - name: Upload to Nightly Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nightly
          name: "Nightly Build"
          body: |
            頁面提供的打包文件對應不同的 Git 分支組合：
            
            ### moran
            - **trad**: 傳承字版
            - **simp**: 簡體字版
            
            ### kagiroi
            - **main**: 詞庫以 `dict.yaml` 提供
            - **build**: 詞庫以二進制提供，無法修改，但可較快完成初次部署
            
            ### mungyeong
            - **main**: 單一版本
            ---
            更新時間: ${{ github.event.head_commit.timestamp || 'Scheduled Run' }}
          files: "*.zip"
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
